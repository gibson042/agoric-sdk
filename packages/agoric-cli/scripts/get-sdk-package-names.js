#! /usr/bin/env node
/* global process, Buffer */
import { spawn } from 'child_process';
import { basename } from 'path';

const ps = spawn('yarn', ['workspaces', '--silent', 'info'], {
  stdio: ['ignore', 'pipe', 'inherit'],
});

// Get Buffers of output.
const chunks = [];
ps.stdout.on('data', data => chunks.push(data));

// Wait for the process to exit.
ps.on('close', code => {
  if (code) {
    throw new Error(`yarn info exited with code ${code}`);
  }

  // Get the output.
  const json = Buffer.concat(chunks).toString('utf8');
  // process.stderr.write(json);

  // Write the module.
  const workspaces = Object.keys(JSON.parse(json)).sort();
  process.stdout.write(`\
// DO NOT EDIT - automatically generated by ${basename(
    new URL(import.meta.url).pathname,
  )}
export default [
${workspaces.map(ws => `  '${ws}',`).join('\n')}
];
`);
});
